<mat-progress-bar color="primary" mode="indeterminate"
    *ngIf="(anyOperationInprogress$|async) || (loadingEntityFeatures$|async) && accessViewProjects">
</mat-progress-bar>

<div *ngIf="sprintModel && isPermissionForViewSprints && isEnableSprintView && accessViewProjects">
    <mat-card class="p-0 unique-detail-height" id="style-1">
        <div fxLayout="row wrap" fxLayout.xs="column" *ngIf="sprintModel">
            <div fxFlex class="mt-05" fxLayoutGap="5px" class="goal-unique-page-height" id="style-1">
                <mat-card-content class="p-0" fxLayout="column">
                    <h6 class="p-05 m-0 unique-details-link ml-05" *ngIf="sprintModel.sprintName">
                        <a matTooltip="{{ 'USERSTORYUNIQUE.CLICKHERETOGOTOPROJECTPAGE' | translate | softLabelsPipe : softLabels}}"
                            class="userstory-unique unique-numbers-hover"
                            (click)="redirectPage(); $event.stopPropagation(); ">
                            {{sprintModel.projectName}}
                        </a>&nbsp;/
                        <a class="unique-numbers-cursor-text" (click)="$event.stopPropagation();">
                            {{sprintModel.sprintUniqueName}}
                        </a>
                    </h6>
                    <div fxLayout="row wrap" class="m-0 ml-05" *ngIf="sprintModel.sprintName">
                        <div fxFlex class="ml-05 unique-details-text ">
                            <span class="unique-details-heading mt-02">
                                {{ sprintModel.sprintName }}</span>
                            <span class="unique-details-heading mr-05"></span>
                            <button mat-icon-button [satPopoverAnchorFor]="editSprintMenuPopover"
                                class="pull-right unique-details-heading mr-05"
                                *ngIf="checkPermissionsForMatMenu()  && !sprintModel.inActiveDateTime && !sprintModel.isComplete"
                                (click)="editSprintMenuPopover.open(); $event.stopPropagation(); ">
                                <fa-icon icon="ellipsis-h" class="goal-unique-menu"></fa-icon>
                            </button>
                        </div>
                    </div>
                    <div fxLayout="row wrap" class="pl-1 m-0" *ngIf="sprintModel">
                        <div *ngIf="sprintModel.sprintResponsiblePersonName"
                            class="unique-background-color custom-goal-padding mr-1 mt-05 mb-1">
                            <div fxLayout="row wrap">
                                <div fxFlex fxLayoutAlign="start center" class="hide-content-overflow">
                                    <h6 class="goal-unique-font-bold m-0">
                                        {{ 'GOALUNIQUE.SPRINTSRESPONSIBLEPERSON' | translate | softLabelsPipe : softLabels}}
                                        &nbsp;</h6>
                                    <app-avatar *ngIf="!sprintModel.profileImage"
                                        [name]="sprintModel.sprintResponsiblePersonName | removeSpecialCharacters"
                                        [isRound]="true" size="20">
                                    </app-avatar>
                                    <img class="employee_img" *ngIf="sprintModel.profileImage"
                                        src="{{ sprintModel.profileImage }}">
                                    &nbsp;{{ sprintModel.sprintResponsiblePersonName }}
                                </div>
                            </div>
                        </div>
                        <div *ngIf="sprintModel.sprintStartDate" class="mt-05">
                            <h6 class="unique-background-color p-05 mr-1">
                                {{ 'SPRINTS.SPRINTSTARTDATE' | translate }}&nbsp;{{ sprintModel.sprintStartDate | date: 'dd/MM/yyyy'}}
                            </h6>
                        </div>
                        <div *ngIf="sprintModel.sprintEndDate" class="mt-05">
                            <h6 class="unique-background-color p-05 mr-1">
                                {{ 'SPRINTS.SPRINTENDDATE' | translate }}&nbsp;{{ sprintModel.sprintEndDate | date: 'dd/MM/yyyy'}}
                            </h6>
                        </div>
                        <div *ngIf="sprintModel.boardTypeName" class="mt-05">
                            <h6 class="unique-background-color p-05 mr-1">
                                {{ 'GOALUNIQUE.BOARDTYPE' | translate }} &nbsp;{{ sprintModel.boardTypeName }}
                            </h6>
                        </div>
                        <div *ngIf="sprintModel.userStoriesCount" class="mt-05">
                            <h6 class="unique-background-color p-05 mr-1">
                                {{ 'GOALUNIQUE.USERSTORIESCOUNT' | translate | softLabelsPipe : softLabels}}&nbsp;
                                {{ sprintModel.userStoriesCount }}
                            </h6>
                        </div>
                        <div *ngIf="sprintModel.completedUserStoriesCount" class="mt-05">
                            <h6 class="unique-background-color p-05 mr-1">
                                {{ 'SPRINTS.COMPLETEDUSERSTORIESCOUNT' | translate | softLabelsPipe : softLabels}}&nbsp;
                                {{ sprintModel.completedUserStoriesCount }}
                            </h6>
                        </div>
                    </div>
                    <div fxFlex class="unique-details-bg p-05" fxLayout="column">
                        <h5 class="unique-details-text pl-1">{{'USERSTORYUNIQUE.DESCRIPTION' | translate}}</h5>
                        <div fxFlex class="ml-05" fxLayout="column">
                            <div fxLayout="row wrap" fxFlex="100" class="word-break">
                                <span fxLayout="row wrap" *ngIf="description && !isEditorVisible"
                                    (click)="enableEditor()" [innerHTML]=description class="pl-2"
                                    style="cursor: pointer;">
                                </span>
                                <!-- <span *ngIf="description && !isEditorVisible" (click)="enableEditor()"
                                    style="cursor: pointer;">
                                    <b>&nbsp;{{'USERSTORYUNIQUE.CLICKHERETOADDDESCRIPTION' | translate}}</b>
                                </span> -->
                                <span *ngIf=" !description && (!isEditorVisible)" (click)="enableEditor()"
                                    style="cursor: pointer;" class="pl-2">
                                    <b>{{'USERSTORYUNIQUE.THEREISNODESCRIPTIONCLICKHERETOADDDESCRIPTION' | translate}}</b>
                                </span>
                            </div>

                            <div fxFlex *ngIf="isEditorVisible">
                                <div class="full-width custom-input">
                                    <editor class="dfree-header custom-logtime-comment"
                                        apiKey="ewi2adl9u4cmc1lic9wcz3zq03696a3ihlodo4n1oaveo3kk"
                                        placeholder="Description" menubar="false" [init]="initSettings"
                                        background="white" height="120" [(ngModel)]="description"
                                        (onKeyUp)="checkCharactersLength($event)">
                                    </editor>
                                </div>
                                <mat-error *ngIf="isDescriptionValidation">
                                    {{ 'SPRINTS.SPRINTDESCRIPTIONCANNOTEXCEED50CHARACTERS' | translate }}
                                </mat-error>
                                <div class="mt-1 ml-05">
                                    <button mat-raised-button color="primary" class="mr-05"
                                        (click)="handleDescriptionEvent()"
                                        [disabled]="(sprintOperationInProgress$ | async)">
                                        <i class="fa fa-spin fa-spinner"
                                            *ngIf="(sprintOperationInProgress$ | async)"></i>
                                        <fa-icon icon="check" class="mr-05"></fa-icon> {{ 'SAVE' | translate }}
                                    </button>
                                    <button mat-raised-button (click)="cancelDescription()" class="mr-05"
                                        [disabled]="(sprintOperationInProgress$ | async)">
                                        <fa-icon icon="times" class="mr-05"></fa-icon> {{ 'CANCEL' | translate }}
                                    </button>
                                    <button mat-raised-button color="primary" (click)="descriptionReset()"
                                        [disabled]="(sprintOperationInProgress$ | async)">
                                        <fa-icon icon="undo" class="mr-05"></fa-icon>
                                        {{ 'ADVANCEDSEARCH.RESET' | translate }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <mat-card class="p-05 ml-1">
                        <div *ngIf="isPermissionForViewUserstories">
                            <app-sprint-workitems-list *ngIf="userStorySearchCriteria && isBoardLayOut"
                                [isBoardLayOut]="isBoardLayOut" [isBacklog]=isBacklog [sprint]="sprintModel"
                                [sprintSearchCriteriaModel]="userStorySearchCriteria" [isUniquePage]=true
                                (getReportsBoard)="getReportsBoard()"
                                (selectedUserStoryEvent)="selectedUserStoryEvent($event)"
                                (eventClicked)="clickBoardEvent($event)" (emitReplanTypeId)="emitReplanType($event)"
                                (getDocumentStore)="getDocumentStore($event)"
                                (getCalenderViewClicked)="getCalenderView()">
                            </app-sprint-workitems-list>
                            <app-pm-sprints-kanban-board
                                *ngIf="userStorySearchCriteria && !isBoardLayOut && !isReportsBoard && !showDocuments"
                                [isBoardLayOut]="isBoardLayOut" [sprint]="sprintModel" [isUniquePage]=true
                                [sprintSearchCriteriaModel]="userStorySearchCriteria"
                                (getReportsBoard)="getReportsBoard()" (eventClicked)="clickBoardEvent($event)"
                                (selectedUserStory)="selectedUserStoryEvent($event)"
                                (getCalenderViewClicked)="getCalenderView()" (emitReplanTypeId)="emitReplanType($event)"
                                (getDocumentStore)="getDocumentStore($event)">
                            </app-pm-sprints-kanban-board>
                        </div>
                        <app-pm-sprints-reports-board *ngIf="isReportsBoard" [sprint]="sprintModel"
                            (eventClicked)="clickBoardEvent($event)" (getReportsBoard)="getReportsBoard()"
                            (getCalenderViewClicked)="getCalenderView()" (getDocumentStore)="getDocumentStore($event)">
                        </app-pm-sprints-reports-board>

                        <ng-container *ngIf="showDocuments">
                            <!-- <app-document-store *ngIf="sprintModel && showDocuments" [sprint]="sprintModel"
                                [fileElement]="fileElement" [isComponentRefresh]="isComponentRefresh"
                                (getDocumentStore)="getDocumentStore($event)"
                                (getReportsBoard)="getReportsBoard()" (eventClicked)="clickBoardEvent($event)"
                                (getCalenderViewClicked)="getCalenderView()">
                            </app-document-store> -->
                            <div *ngIf="documentsModuleLoaded">
                                <app-pm-sprints-board [sprint]="sprintModel" [isDocumentView]=true
                                    (eventClicked)="clickBoardEvent($event)" (reportsBoardClicked)="getReportsBoard()"
                                    (getDocumentDetails)="getDocumentStore($event)">
                                </app-pm-sprints-board>

                                <ndc-dynamic *ngIf="sprintModel && showDocuments"
                                    [ndcDynamicFactory]="documentStoreComponent.component"
                                    [ndcDynamicComponent]="documentStoreComponent.component"
                                    [ndcDynamicInjector]="injector" [ndcDynamicInputs]="documentStoreComponent.inputs"
                                    [ndcDynamicOutputs]="documentStoreComponent.outputs">
                                </ndc-dynamic>
                            </div>
                        </ng-container>

                        <app-goal-component-calender-view-detail *ngIf="showCalendarView" [sprint]="sprintModel"
                            (eventClicked)="clickBoardEvent($event)" [workItemList]=null class="dispaly-grid"
                            (getCalenderViewClicked)="getCalenderView()" (getReportsBoard)="getReportsBoard()">
                        </app-goal-component-calender-view-detail>
                    </mat-card>
                </mat-card-content>
                <div fxLayout="row wrap" class="mt-1 p-05 ml-05 "
                    *ngIf="!sprintModel.inActiveDateTime && !sprintModel.isComplete">
                    <div fxFlex="85px" fxLayoutAlign="start center">
                        <span>
                            <h6 class="unique-details-text custom-activity-margin">
                                {{'USERSTORYUNIQUE.COMMENTS'|translate}} </h6>
                        </span>
                    </div>
                    <!-- <div fxFlex="150px">
                        <ng-select [searchable]="false" [clearable]="false" (change)="selectchange($event)"
                            [(ngModel)]="selectedGoalTab">
                            <ng-option [value]="dropdown.value" *ngFor="let dropdown of dropdowns">
                                {{ dropdown.name }}</ng-option>
                        </ng-select>
                    </div> -->
                </div>
                <div class="unqiue-activity-tab ml-05" *ngIf="!sprintModel.inActiveDateTime && !sprintModel.isComplete">
                    <div fxFlex>
                        <snovasys-comments *ngIf="sprintModel.sprintId" [receiverId]="sprintModel.sprintId"
                            [componentModel]="componentModel" [isPermissionExists]="true">
                        </snovasys-comments>
                    </div>
                </div>
            </div>
            <div fxFlex="30" *ngIf="selectedDetails">
                <mat-card class="p-0">
                    <mat-progress-bar color="primary" mode="indeterminate" *ngIf="(userStoryIsInProgress$|async)">
                    </mat-progress-bar>
                    <gc-userstory-detail *ngIf="selectedDetails" [userStoryId]="selectedDetails"
                        [goalReplanId]="replanTypeId" [isUserStoriesPage]="true"
                        [selectedGoalId]="selectedDetails.sprintId" [isSprintUserStories]=true
                        (userStoryCloseClicked)="userStoryCloseClicked()">
                    </gc-userstory-detail>

                </mat-card>
            </div>
        </div>
    </mat-card>
</div>


<app-common-message-box *ngIf=" sprintModel && isPermissionForViewSprints && !isEnableSprintView"
    textToDisplay="{{'PROJECTS.PLEASECONFIGURESPRINTSETTINGS'|translate}}">
</app-common-message-box>


<sat-popover backdropClass="backdrop-color" class="goal-options custom-goal-unique-background" #editSprintMenuPopover
    hasBackdrop [interactiveClose]="true" verticalAlign="below" (click)="$event.stopPropagation()"
    horizontalAlign="end">
    <mat-card class="filter-data p-0">
        <button mat-menu-item class="allgoals_icons" [satPopoverAnchorFor]="startSprintPopover"
            (click)="startSprintPopover.open(); $event.stopPropagation();clearStartSprintsForm()"
            *ngIf="(canAccess_entityType_feature_StartSprint) && (sprintModel && !sprintModel.sprintStartDate)">
            <mat-icon>queue</mat-icon><span>{{ 'SPRINTS.STARTSPRINT' | translate }} </span>
        </button>
        <button mat-menu-item class="allgoals_icons" *ngIf="(canAccess_entityType_feature_AddOrUpdateSprint)"
            [satPopoverAnchorFor]="editSprintPopover"
            (click)="editSprintPopover.open(); $event.stopPropagation();editSprintForm()">
            <mat-icon>edit</mat-icon>{{'SPRINTS.EDITSPRINT' | translate}}
        </button>
        <button mat-menu-item class="allgoals_icons" *ngIf="(canAccess_entityType_feature_DeleteSprint)"
            [satPopoverAnchorFor]="deleteSprintPopover" (click)="deleteSprintPopover.open(); $event.stopPropagation();">
            <mat-icon>delete</mat-icon>{{'SPRINTS.DELETESPRINT' | translate}}
        </button>
        <button mat-menu-item class="allgoals_icons"
            *ngIf="(canAccess_entityType_feature_CompleteSprint) && (sprintModel && sprintModel.sprintStartDate)"
            [satPopoverAnchorFor]="completeSprintPopover"
            (click)="completeSprintPopover.open(); $event.stopPropagation();">
            <mat-icon>check_circle</mat-icon>{{'SPRINTS.COMPLETESPRINT' | translate}}
        </button>
    </mat-card>
</sat-popover>


<sat-popover #startSprintPopover verticalAlign="below" backdropClass="backdrop-color" hasBackdrop horizontalAlign="end">
    <mat-card class="filter-data p-0" style="width: 358px;">
        <mat-card-title class="text-center">
            <div class="card-title-text mat-bg-primary p-05 mb-1">
                <span> {{ 'SPRINTS.STARTSPRINT' | translate }}
                </span>
            </div>
        </mat-card-title>
        <form [formGroup]="sprintStartForm" novalidate (submit)="sprintStartForm.valid && startSprint()">
            <div class="card-content p-05">
                <div fxLayout="row wrap" class="mb-1">
                    <div fxFlex="100" fxFlex.gt-sm="100" fxLayout="column wrap">
                        <mat-form-field class="full-width">
                            <input formControlName="sprintStartDate" matInput [matDatepicker]="startDatePicker"
                                (click)="startDatePicker.open()" (dateChange)="changeStartDate()"
                                placeholder="{{ 'SPRINTS.SPRINTSTARTDATE' | translate }}" required />
                            <mat-datepicker-toggle matSuffix [for]="startDatePicker"></mat-datepicker-toggle>
                            <mat-datepicker #startDatePicker></mat-datepicker>
                            <mat-error>
                                <span
                                    *ngIf="sprintStartForm.get('sprintStartDate').hasError('required') && sprintStartForm.get('sprintStartDate').touched">{{ 'SPRINTS.PLEASEENTERSPRINTSTARTDATE' | translate }}
                                </span>
                            </mat-error>
                        </mat-form-field>
                        <mat-form-field class="full-width">
                            <input formControlName="sprintEndDate" matInput [matDatepicker]="endDatePicker"
                                (click)="endDatePicker.open()" [min]="minDate"
                                placeholder="{{ 'SPRINTS.SPRINTENDDATE' | translate }}" required />
                            <mat-datepicker-toggle matSuffix [for]="endDatePicker"></mat-datepicker-toggle>
                            <mat-datepicker #endDatePicker></mat-datepicker>
                            <mat-error>
                                <span
                                    *ngIf="sprintStartForm.get('sprintEndDate').hasError('required') && sprintStartForm.get('sprintEndDate').touched">{{ 'SPRINTS.PLEASEENTERSPRINTENDDATE' | translate }}
                                </span>
                            </mat-error>
                        </mat-form-field>
                    </div>
                </div>
                <div class="text-center">
                    <button mat-raised-button type="submit" color="primary" class="mr-05"
                        [disabled]="!sprintStartForm.valid || (startSprintOperationInProgress$ | async)">
                        <mat-progress-bar color="primary" mode="indeterminate"
                            *ngIf="(startSprintOperationInProgress$| async)">
                        </mat-progress-bar>
                        <fa-icon icon="save" class="mr-05"></fa-icon> {{ 'SAVE' | translate }}
                    </button>
                    <button mat-raised-button type="button"
                        (click)="cancelStartSprintPopup();startSprintPopover.close()"
                        [disabled]="(startSprintOperationInProgress$| async)">
                        <fa-icon icon="times" class="mr-05"></fa-icon> {{ 'CANCEL' | translate }}
                    </button>
                </div>
            </div>
        </form>
    </mat-card>
</sat-popover>

<sat-popover #completeSprintPopover verticalAlign="below" backdropClass="backdrop-color" hasBackdrop
    horizontalAlign="end">
    <mat-card class="filter-data p-0">
        <mat-card-title class="text-center">
            <div class="card-title-text mat-bg-primary p-05 mb-1">
                <span> {{ 'SPRINTS.COMPLETESPRINT' | translate }}
                </span>
            </div>
        </mat-card-title>

        <span class="p-05"> {{ 'SPRINTS.AREYOUSUREWANTTOMOVETHEINCOMPLETEWORKITEMSTOBACKLOG' | translate }}
        </span>

        <div class="text-center mb-05">
            <button mat-raised-button type="button" color="primary" class="mr-05"
                (click)="completeSprint(); $event.stopPropagation()"
                [disabled]="(sprintDeleteOperationInProgress$ | async)">
                <mat-progress-bar color="primary" mode="indeterminate"
                    *ngIf="(sprintDeleteOperationInProgress$ | async)">
                </mat-progress-bar>
                <fa-icon icon="check" class="mr-05"></fa-icon> {{ 'YES' | translate }}
            </button>
            <button mat-raised-button type="button" (click)="closeDeletePopup();completeSprintPopover.close()"
                [disabled]="(sprintDeleteOperationInProgress$ | async)">
                <fa-icon icon="times" class="mr-05"></fa-icon> {{ 'NO' | translate }}
            </button>
        </div>
    </mat-card>
</sat-popover>


<sat-popover #deleteSprintPopover verticalAlign="below" backdropClass="backdrop-color" hasBackdrop
    horizontalAlign="end">
    <mat-card class="filter-data p-05">
        <mat-card-title class="text-center">
            <div class="card-title-text mb-1">
                <span> {{ 'SPRINTS.AREYOUSUREWANTTODELETETHISSPRINT' | translate }}
                </span>
            </div>
        </mat-card-title>
        <div class="text-center">
            <button mat-raised-button type="button" color="primary" class="mr-05"
                (click)="deleteSprint(); $event.stopPropagation()"
                [disabled]="(sprintArchiveOperationInProgress$ | async)">
                <mat-progress-bar color="primary" mode="indeterminate"
                    *ngIf="(sprintArchiveOperationInProgress$ | async)">
                </mat-progress-bar>
                <fa-icon icon="check" class="mr-05"></fa-icon> {{ 'YES' | translate }}
            </button>
            <button mat-raised-button type="button" (click)="closeArchivePopup();deleteSprintPopover.close()"
                [disabled]="(sprintArchiveOperationInProgress$ | async)">
                <fa-icon icon="times" class="mr-05"></fa-icon> {{ 'NO' | translate }}
            </button>
        </div>
    </mat-card>
</sat-popover>


<sat-popover #editSprintPopover verticalAlign="below" backdropClass="backdrop-color" hasBackdrop horizontalAlign="end">
    <mat-card class="filter-data p-0" style="width: 376px;">
        <mat-progress-bar color="primary" mode="indeterminate" *ngIf="(sprintOperationInProgress$ | async)">
        </mat-progress-bar>
        <mat-card-title class="text-center">
            <div class="card-title-text mat-bg-primary p-05 mb-1">
                <span> {{ 'SPRINTS.EDITSPRINT' | translate }}
                </span>
            </div>
        </mat-card-title>
        <app-edit-sprint *ngIf="isEditSprint" [sprint]="sprintModel" [isEnableTestRepo]="isEnableTestRepo"
            (closeEditSprintPopUp)="closeSprintPopup()">
        </app-edit-sprint>
    </mat-card>
</sat-popover>



<app-common-message-box
    *ngIf=" (!isPermissionForViewSprints &&  !isLoading && !(anyOperationInprogress$|async)) || !accessViewProjects"
    textToDisplay="{{'DONTHAVEANYPERMISSIONS'|translate}}">
</app-common-message-box>