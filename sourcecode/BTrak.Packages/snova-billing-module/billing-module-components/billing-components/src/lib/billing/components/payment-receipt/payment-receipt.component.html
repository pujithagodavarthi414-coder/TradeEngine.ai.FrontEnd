<div class="p-0 m-0 full-height" *ngIf="canAccess_feature_ManagePaymentReceipt">
    <mat-card class="p-0 m-0">
        <mat-card-title class="data-table-header drag-handler">
            <div fxLayout="row wrap" fxLayoutGap="0">
                <div fxFlex fxLayoutAlign="start center">
                    <div class="card-title-text pl-05 ml-05">{{ 'PAYMENTRECEIPT.PAYMENTRECEIPTS' | translate |
                        titlecase}}
                    </div>
                </div>
                <div fxFlex="50px">
                    <button mat-icon-button matTooltip="{{ 'PAYMENTRECEIPT.ADDNEWPAYMENTRECEIPT' | translate }}"
                        [satPopoverAnchorFor]="addPaymentReceiptPopOver" #addPaymentReceiptPopUp="satPopoverAnchor"
                        (click)="openPaymentReceiptPopUp(addPaymentReceiptPopUp)" class="mt-02">
                        <fa-icon icon="plus" class="filter mat-color-accent">
                        </fa-icon>
                    </button>
                </div>
            </div>
            <mat-divider></mat-divider>
        </mat-card-title>
    </mat-card>
    <div class="no-drag" *ngIf="paymentReceiptModel.length > 0">
        <kendo-grid [data]="paymentReceiptModelList" [pageSize]="state.take" [skip]="state.skip" [pageable]="true"
            [sortable]="true" [sort]="state.sort" [filterable]="false" [loading]="isLoading"
            (dataStateChange)="dataStateChange($event)">
            <kendo-grid-column field="entryDate" title="{{'EXPENSEBOOKING.ENTRYDATE' | translate}}">
                <ng-template kendoGridCellTemplate let-dataItem>
                    <div>
                        {{ dataItem.entryDate | utcToLocalTime | date: 'dd-MMM-yyyy' }}
                    </div>
                </ng-template>
            </kendo-grid-column>
            <kendo-grid-column field="term" title="{{'ENTITYFORM.TERM' | translate}}"></kendo-grid-column>
            <kendo-grid-column field="bankReceiptDate" title="{{'PAYMENTRECEIPT.BANKRECEIPTDATE' | translate}}">
                <ng-template kendoGridCellTemplate let-dataItem>
                    <div>
                        {{ dataItem.bankReceiptDate | utcToLocalTime | date: 'dd-MMM-yyyy' }}
                    </div>
                </ng-template>
            </kendo-grid-column>
            <kendo-grid-column field="bankReference" title="{{'PAYMENTRECEIPT.BANKREFERENCE' | translate}}"></kendo-grid-column>
            <kendo-grid-column field="siteName" title="{{'SOLARLOG.SITENAME' | translate}}"></kendo-grid-column>
            <kendo-grid-column field="bankAccountName" title="{{'BANKACCOUNT.NAME' | translate}}"></kendo-grid-column>
            <kendo-grid-column field="creditNoteNames" title="{{'CREDITNOTE.CREDITNOTE' | translate}}"></kendo-grid-column>
            <kendo-grid-column field="entryFormNames" title="{{'PAYMENTRECEIPT.ENTRYFORMS' | translate}}"></kendo-grid-column>
            <kendo-grid-column field="payValue" title="{{'PAYMENTRECEIPT.VALUE' | translate}}"></kendo-grid-column>
            <kendo-grid-command-column title="{{'KYCCONFIG.ACTIONS' | translate}}">
                <ng-template kendoGridCellTemplate let-dataItem>
                    <fa-icon class="mat-color-accent cursor-pointer mr-1" icon="edit"
                        [satPopoverAnchorFor]="addPaymentReceiptPopOver" #addPaymentReceiptPopUp="satPopoverAnchor"
                        matTooltip="{{ 'PAYMENTRECEIPT.EDITPAYMENTRECEIPT' | translate}}"
                        (click)="editPaymentReceiptPopUp(dataItem,addPaymentReceiptPopUp)">
                    </fa-icon>
                    <fa-icon class="mat-color-accent cursor-pointer mr-1" [satPopoverAnchorFor]="archivegrdPopOver"
                        #archivePaymentReceiptPopUp="satPopoverAnchor"
                        matTooltip="{{ 'PAYMENTRECEIPT.ARCHIVEPAYMENTRECEIPT' | translate}}"
                        (click)="deletePaymentReceiptPopUp(dataItem,archivePaymentReceiptPopUp)" icon="trash">
                    </fa-icon>
                </ng-template>
            </kendo-grid-command-column>
        </kendo-grid>
    </div>
    <app-common-message-box class="no-drag" *ngIf="!isLoading && paymentReceiptModel.length === 0"
        textToDisplay="{{'PAYMENTRECEIPT.YOUDONTHAVEANYPAYMENTRECEIPT' | translate}}">
        <ng-template ng-message-tmp>
            <button mat-button mat-raised-button class="mr-05 text-center mt-1" color="primary"
                [satPopoverAnchorFor]="addPaymentReceiptPopOver" #addPaymentReceiptPopUp="satPopoverAnchor"
                (click)="openPaymentReceiptPopUp(addPaymentReceiptPopUp)">
                <fa-icon class="mr-05" icon="plus"></fa-icon>{{'PAYMENTRECEIPT.ADDNEWPAYMENTRECEIPT' | translate}}
            </button>
        </ng-template>
    </app-common-message-box>
</div>

    <sat-popover #addPaymentReceiptPopOver [interactiveClose]="false" hasBackdrop horizontalAlign="end">
        <mat-card class="filter-data p-0">
            <div class="card-title-text mat-bg-primary p-05 text-center">
                <div class="card-title-text" *ngIf="!paymentReceiptId">{{ 'PAYMENTRECEIPT.CREATEPAYMENTRECEIPT' |
                    translate }}
                </div>
                <div class="card-title-text" *ngIf="paymentReceiptId">{{ 'PAYMENTRECEIPT.UPDATEPAYMENTRECEIPT' |
                    translate }}
                </div>
            </div>
            <form [formGroup]="paymentReceiptForm" novalidate #formDirective="ngForm" (submit)="upsertPaymentReceipt(formDirective)">
                <div id="style-1" class="goal-create-height p-1">
                    <div fxLayout="row" fxLayoutAlign="space-around center">
                        <div fxFlex="23">
                            <mat-form-field class="full-width">
                                <mat-label>{{'EXPENSEBOOKING.ENTRYDATE' | translate}}</mat-label>
                                <input matInput [matDatepicker]="picker1" (click)="picker1.open()"
                                    formControlName="entryDate" placeholder="" required>
                                <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
                                <mat-datepicker #picker1></mat-datepicker>
                                <mat-error
                                    *ngIf="paymentReceiptForm.get('entryDate').hasError('required') && paymentReceiptForm.get('entryDate').touched">
                                    {{'EXPENSEBOOKING.PLEASESELECTENTRYDATE' | translate}}</mat-error>
                            </mat-form-field>
                        </div>
                        <div fxFlex="23">
                            <app-month-picker (monthEmit)="monthEmitHandled($event)" [month]="month"
                                [disabled]="false">
                            </app-month-picker>
                        </div>
                        <div fxFlex="23">
                            <app-year-picker (yearEmit)="yearEmitHandled($event)" [year]="year"
                                [disabled]="false">
                            </app-year-picker>
                        </div>
                        <div fxFlex="23">
                            <mat-form-field class="full-width ml-05">
                                <mat-label> {{'ENTITYFORM.TERM' | translate}}</mat-label>
                                <mat-select placeholder=" {{'ENTITYFORM.SELECTTERM' | translate}}"
                                    formControlName="term" required>
                                    <mat-option *ngFor="let termo of terms" [value]="termo.name">
                                        {{termo.name}}
                                    </mat-option>
                                </mat-select>
                                <mat-error
                                    *ngIf="paymentReceiptForm.get('term').hasError('required') && paymentReceiptForm.get('term').touched">
                                    {{'ENTITYFORM.PLEASESELECTTERM' | translate}}</mat-error>
                            </mat-form-field>
                        </div>
                    </div>
                    <div fxLayout="row" fxLayoutAlign="space-around center">
                        <div fxFlex="23">
                            <mat-form-field class="full-width">
                                <mat-label>{{'ENTITYFORM.SITE' | translate}}</mat-label>
                                <mat-select placeholder="{{'ENTITYFORM.SELECTSITE' | translate}}"
                                    formControlName="siteId"
                                    required>
                                    <mat-option *ngFor="let site of sites" [value]="site.id">
                                        {{site.name}}
                                    </mat-option>
                                </mat-select>
                                <mat-error
                                    *ngIf="paymentReceiptForm.get('siteId').hasError('required') && paymentReceiptForm.get('siteId').touched">
                                    {{'ENTITYFORM.PLEASESELECTSITE' | translate}}</mat-error>
                            </mat-form-field>
                        </div>
                        <div fxFlex="23">
                            <mat-form-field class="full-width">
                                <mat-label>{{'PAYMENTRECEIPT.DATEOFRECEIPT' | translate}}</mat-label>
                                <input matInput [matDatepicker]="picker3" (click)="picker3.open()"
                                    formControlName="bankReceiptDate" placeholder="" required>
                                <mat-datepicker-toggle matSuffix [for]="picker3"></mat-datepicker-toggle>
                                <mat-datepicker #picker3></mat-datepicker>
                            </mat-form-field>
                        </div>
                        <div fxFlex="23">
                            <mat-form-field class="full-width">
                                <input formControlName="bankReference" matInput
                                    placeholder="{{'PAYMENTRECEIPT.BANKREFERENCENO' | translate}}" required>
                                <mat-error>
                                    <span
                                        *ngIf="paymentReceiptForm.get('bankReference').hasError('required') && paymentReceiptForm.get('bankReference').touched">{{'PAYMENTRECEIPT.PLEASEENTERBANKREFERENCENO'
                                        | translate}}
                                    </span>
                                    <span
                                        *ngIf="paymentReceiptForm.get('bankReference').hasError('maxlength')">{{'PAYMENTRECEIPT.BANKREFERENCENOCANNOTEXCEED250CHARACTERS'
                                        | translate}}
                                    </span>
                                </mat-error>
                            </mat-form-field>
                        </div>
                        <div fxFlex="23">

                        </div>
                    </div>
                    <div fxLayout="row" fxLayoutAlign="space-around center">
                        <div fxFlex="23">
                            <mat-form-field class="full-width">
                                <mat-label>{{'BANKACCOUNT.BANKACCOUNT' | translate}}</mat-label>
                                <mat-select placeholder="{{'BANKACCOUNT.SELECTBANKACCOUNT' | translate}}"
                                    formControlName="bankId" (selectionChange)="getSelectedBank($event.value)"
                                    required>
                                    <mat-option *ngFor="let bank of banks" [value]="bank.id">
                                        {{bank.bankAccountName}}
                                    </mat-option>
                                </mat-select>
                                <mat-error
                                    *ngIf="paymentReceiptForm.get('bankId').hasError('required') && paymentReceiptForm.get('bankId').touched">
                                    {{'BANKACCOUNT.PLEASESELECTBANKACCOUNT' | translate}}</mat-error>
                            </mat-form-field>
                        </div>
                        <div fxFlex="23" fxLayout="column">
                            <span>{{'BANKACCOUNT.NAME' | translate}}</span>
                            <span>{{selectedBank.iban}}</span>
                        </div>
                        <div fxFlex="23">
                            <mat-form-field class="full-width">
                                <mat-select formControlName="creditNoteIds" [compareWith]="compareSelectedCreditNotesFn"
                                    placeholder="{{'CREDITNOTE.CREDITNOTE' | translate}}" multiple
                                    (selectionChange)="getSelectedCreditss()">
                                    <mat-select-trigger>
                                        {{creditNoteNames}}
                                    </mat-select-trigger>
                                    <mat-option [value]="0" #allSelected (click)="toggleAllCreditssSelected()">
                                        Select all
                                    </mat-option>
                                    <mat-option *ngFor="let expense of expenses" [value]="expense.id"
                                        (click)="toggleCreditssPerOne($event)">
                                        NC-{{expense.siteName}}-{{expense.year  | utcToLocalTime | date: 'yyyy' }}
                                    </mat-option>
                                </mat-select>
                                <!-- <mat-error>
                                    <span
                                        *ngIf="paymentReceiptForm.get('creditNoteIds').hasError('required') && paymentReceiptForm.get('creditNoteIds').touched">
                                        {{'PAYMENTRECEIPT.PLEASESELECTCREDITS' | translate}}</span></mat-error> -->
                            </mat-form-field>
                        </div>
                        <div fxFlex="23">
                            <mat-form-field class="full-width">
                                <mat-select formControlName="entryFormIds" [compareWith]="compareSelectedEntryFormFn"
                                    placeholder="{{'PAYMENTRECEIPT.INVOICEREFERENCE' | translate}}" multiple
                                    (selectionChange)="getSelectedEntryForms()">
                                    <mat-select-trigger>
                                        {{gridInvoiceNames}}
                                    </mat-select-trigger>
                                    <mat-option [value]="0" #allEntryFormsSelected (click)="toggleAllEntryFormsSelected()">
                                        Select all
                                    </mat-option>
                                    <mat-option *ngFor="let entryForm of entryForms" [value]="entryForm.id"
                                        (click)="toggleEntryFormsPerOne($event)">
                                        {{entryForm.gridInvoiceName}}
                                    </mat-option>
                                </mat-select>
                                <!-- <mat-error>
                                    <span
                                        *ngIf="paymentReceiptForm.get('entryFormIds').hasError('required') && paymentReceiptForm.get('entryFormIds').touched">
                                        {{'PAYMENTRECEIPT.PLEASESELECTINVOICEREFERENCE' | translate}}</span></mat-error> -->
                            </mat-form-field>
                        </div>
                    </div>
                    <div fxLayout="row" fxLayoutAlign="space-around center">
                        <div fxFlex="45">
                        <mat-form-field class="full-width">
                            <textarea matInput formControlName="comments" rows="5"
                                placeholder="{{'EXPENSEBOOKING.COMMENTS'|translate}}"></textarea>
                                <mat-error>
                                    <span
                                    *ngIf="paymentReceiptForm.get('comments').hasError('maxlength')">
                                        {{'PAYMENTRECEIPT.COMMENTSSHOULDBE150CHARACTERS' | translate}}</span></mat-error>
                        </mat-form-field>
                        </div>
                        <div fxFlex="45">
                            <div fxLayout="column" fxFlex="50" class="mt-2">
                                <div fxFlex="100">
                                    <mat-form-field class="full-width">
                                        <input formControlName="payValue" matInput  (keypress)="numberOnlyWithVal($event, $event.target.value)" mask="separator.2" thousandSeparator="," min=1
                                            placeholder="{{'PAYMENTRECEIPT.VALUE' | translate}}" required>
                                            <span matSuffix>(CHF)</span>
                                        <mat-error>
                                            <span
                                                *ngIf="paymentReceiptForm.get('payValue').hasError('required') && paymentReceiptForm.get('payValue').touched">{{'PAYMENTRECEIPT.PLEASEENTERVALUE'
                                                | translate}}
                                            </span>
                                            <span
                                                *ngIf="paymentReceiptForm.get('payValue').hasError('max')">{{'PAYMENTRECEIPT.VALUECANNOTEXCEED250CHARACTERS'
                                                | translate}}
                                            </span>
                                        </mat-error>
                                    </mat-form-field>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
<div class="text-center mb-1 prl-1">
    <button mat-raised-button type="submit" color="primary" class="mr-1"
        [disabled]="!paymentReceiptForm.valid||isAddIsInProgress">
        <mat-progress-bar color="primary" mode="indeterminate" *ngIf="isAddIsInProgress">
        </mat-progress-bar>
        <fa-icon class="mr-05" icon="save"></fa-icon> {{ 'SAVE' | translate }}
    </button>
    <button mat-button mat-raised-button (click)="closePopUp(formDirective)" type="button">
        <fa-icon class="mr-05" icon="times"></fa-icon>
        {{ 'CANCEL' | translate }}
    </button>
</div>
</form>
</mat-card>
</sat-popover>

<sat-popover #archivegrdPopOver [interactiveClose]="false" hasBackdrop horizontalAlign="end">
    <mat-card class="p-1">
        <mat-card-title class="text-center">
            <div class="card-title-text mat-bg-primary p-05">
                {{ 'PAYMENTRECEIPT.DELETEPAYMENTRECEIPT' | translate }}</div>
          </mat-card-title>
          <p class="p-05 m-0">{{ 'PAYMENTRECEIPT.AREYOUSUREWANTTODELETEPAYMENTRECEIPT' | translate }}
          </p>
        <div class="text-center">
            <button mat-button mat-raised-button color="primary" class="mr-1" (click)="archivePaymentReceipt();">
                <fa-icon icon="check" class="mr-05"> </fa-icon> {{ 'YES' | translate }} &nbsp;
            </button>
            <button mat-button mat-raised-button (click)="closeDeletePopup();">
                <fa-icon class="mr-05" icon="times"></fa-icon> {{ 'ROSTER.NO' | translate }}
            </button>
        </div>
    </mat-card>
</sat-popover>

<app-common-message-box textToDisplay="{{ 'PERMISSIONMESSAGE' | translate }}" *ngIf="!(canAccess_feature_ManagePaymentReceipt)">
</app-common-message-box>